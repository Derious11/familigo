rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ========================
       HELPERS
       ======================== */
    function isSignedIn() {
      return request.auth != null;
    }

    // TEMP: Firestore-based admin disabled unless explicitly needed
    function isAdmin() {
      return false;
    }

    /* ========================
       USERS
       ======================== */
    match /users/{userId} {

      /* -------- READ -------- */
      allow read: if isSignedIn() && (
        // Self
        request.auth.uid == userId

        // Parent â†’ child
        || (
          resource.data.parentId != null
          && resource.data.parentId == request.auth.uid
        )

        // Same family
        || (
          resource.data.familyCircleId != null
          && resource.data.familyCircleId
              == get(/databases/$(database)/documents/users/$(request.auth.uid))
                 .data.familyCircleId
        )
      );

      /* -------- CREATE -------- */
      allow create: if isSignedIn() && (
        // Normal signup
        (
          request.auth.uid == userId
          && !request.resource.data.keys().hasAny(["isAdmin"])
        )

        // Parent creates child
        || (
          request.auth.uid != userId
          && request.resource.data.parentId == request.auth.uid
          && request.resource.data.familyCircleId != null
          && !request.resource.data.keys().hasAny(["isAdmin"])
        )
      );

      /* -------- UPDATE -------- */
      allow update: if isSignedIn() && (

        // Self updates safe fields only
        (
          request.auth.uid == userId
          && !request.resource.data
              .diff(resource.data)
              .affectedKeys()
              .hasAny(["isAdmin", "role", "parentId"])
        )

        // Parent updates child (safe fields only)
        || (
          resource.data.parentId == request.auth.uid
          && !request.resource.data
              .diff(resource.data)
              .affectedKeys()
              .hasAny([
                "isAdmin",
                "role",
                "parentId",
                "email",
                "emailVerified"
              ])
        )
      );

      allow delete: if false;
    }

    /* ========================
       FAMILY CIRCLES
       ======================== */
    match /familyCircles/{circleId} {

      allow create: if isSignedIn();

      allow read, update: if isSignedIn()
        && (
          // Primary: membership map
          resource.data.members[request.auth.uid] == true
          // Backward compatibility while the map is being populated
          || (
            resource.data.members[request.auth.uid] == null
            && request.auth.uid in resource.data.memberIds
          )
        );
    }

    /* ========================
       CHALLENGES
       ======================== */
    match /challenges/{challengeId} {

      allow read: if isSignedIn();

      allow create, update, delete: if isSignedIn()
        && (
          get(/databases/$(database)/documents/familyCircles/$(request.resource.data.familyCircleId))
              .data.members[request.auth.uid] == true
          || (
            get(/databases/$(database)/documents/familyCircles/$(request.resource.data.familyCircleId))
                .data.members[request.auth.uid] == null
            && request.auth.uid in get(/databases/$(database)/documents/familyCircles/$(request.resource.data.familyCircleId))
                .data.memberIds
          )
        );
    }

    /* ========================
       REPLIES
       ======================== */
    match /replies/{replyId} {

      allow read: if isSignedIn();

      allow create, update, delete: if isSignedIn()
        && (
          get(/databases/$(database)/documents/familyCircles/$(request.resource.data.familyCircleId))
              .data.members[request.auth.uid] == true
          || (
            get(/databases/$(database)/documents/familyCircles/$(request.resource.data.familyCircleId))
                .data.members[request.auth.uid] == null
            && request.auth.uid in get(/databases/$(database)/documents/familyCircles/$(request.resource.data.familyCircleId))
                .data.memberIds
          )
        );
    }

    /* ========================
       MESSAGES
       ======================== */
    match /messages/{messageId} {

      allow read, create, update, delete: if isSignedIn()
        && (
          get(/databases/$(database)/documents/familyCircles/$(resource.data.familyCircleId))
              .data.members[request.auth.uid] == true
          || (
            get(/databases/$(database)/documents/familyCircles/$(resource.data.familyCircleId))
                .data.members[request.auth.uid] == null
            && request.auth.uid in get(/databases/$(database)/documents/familyCircles/$(resource.data.familyCircleId))
                .data.memberIds
          )
        );
    }

    /* ========================
       STATIC DATA
       ======================== */
    match /badges/{id} {
      allow read: if isSignedIn();
    }

    match /exercises/{id} {
      allow read: if isSignedIn();
    }

    /* ========================
       DENY ALL ELSE
       ======================== */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
