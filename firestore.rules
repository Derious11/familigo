rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ========================
       HELPERS
       ======================== */
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user is a member of the given family circle
    function isFamilyMember(familyCircleId) {
      let familyCircleData = get(/databases/$(database)/documents/familyCircles/$(familyCircleId)).data;
      return familyCircleData.members[request.auth.uid] == true
          || (familyCircleData.members[request.auth.uid] == null && request.auth.uid in familyCircleData.memberIds);
    }

    // TEMP: Firestore-based admin disabled unless explicitly needed
    function isAdmin() {
      return false;
    }

    /* ========================
       USERS
       ======================== */
    match /users/{userId} {

      /* -------- READ -------- */
      allow read: if isSignedIn() && (
        // Self
        request.auth.uid == userId

        // Parent â†’ child
        || (
          resource.data.parentId != null
          && resource.data.parentId == request.auth.uid
        )

        // Same family
        || (
          resource.data.familyCircleId != null
          && isFamilyMember(resource.data.familyCircleId)
        )
      );

      /* -------- CREATE -------- */
      allow create: if isSignedIn() && (
        // Normal signup
        (
          request.auth.uid == userId
          && !request.resource.data.keys().hasAny(["isAdmin"])
        )

        // Parent creates child
        || (
          request.auth.uid != userId
          && request.resource.data.parentId == request.auth.uid
          && request.resource.data.familyCircleId != null
          && !request.resource.data.keys().hasAny(["isAdmin"])
        )
      );

      /* -------- UPDATE -------- */
      allow update: if isSignedIn() && (

        // Self updates safe fields only
        (
          request.auth.uid == userId
          && !request.resource.data
              .diff(resource.data)
              .affectedKeys()
              .hasAny(["isAdmin", "role", "parentId"])
        )

        // Parent updates child (safe fields only)
        || (
          resource.data.parentId == request.auth.uid
          && !request.resource.data
              .diff(resource.data)
              .affectedKeys()
              .hasAny([
                "isAdmin",
                "role",
                "parentId",
                "email",
                "emailVerified"
              ])
        )
      );

      allow delete: if false;
    }

    /* ========================
       FAMILY CIRCLES
       ======================== */
    match /familyCircles/{circleId} {

      allow create: if isSignedIn();

      allow read, update: if isSignedIn() && isFamilyMember(circleId);
    }

    /* ========================
       CHALLENGES
       ======================== */
    match /challenges/{challengeId} {

      allow read: if isSignedIn();

      allow create: if isSignedIn() && isFamilyMember(request.resource.data.familyCircleId);
      
      // Updates usually don't change the familyCircleId, so we check the existing one
      allow update: if isSignedIn() && isFamilyMember(resource.data.familyCircleId);
      
      allow delete: if isSignedIn() && isFamilyMember(resource.data.familyCircleId);
    }

    /* ========================
       REPLIES
       ======================== */
    match /replies/{replyId} {

      allow read: if isSignedIn();

      allow create: if isSignedIn() && isFamilyMember(request.resource.data.familyCircleId);
      
      allow update: if isSignedIn() && isFamilyMember(resource.data.familyCircleId);
      
      allow delete: if isSignedIn() && isFamilyMember(resource.data.familyCircleId);
    }

    /* ========================
       MESSAGES
       ======================== */
    match /messages/{messageId} {

      // For CREATE, we must check request.resource.data because resource doesn't exist yet
      allow create: if isSignedIn() && isFamilyMember(request.resource.data.familyCircleId);

      // For READ, UPDATE, DELETE, we check the existing document (resource.data)
      allow read, update, delete: if isSignedIn() && isFamilyMember(resource.data.familyCircleId);
    }

    /* ========================
       STATIC DATA
       ======================== */
    match /badges/{id} {
      allow read: if isSignedIn();
    }

    match /exercises/{id} {
      allow read: if isSignedIn();
    }

    /* ========================
       DENY ALL ELSE
       ======================== */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
